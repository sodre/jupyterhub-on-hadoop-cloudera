# jupyterhub-on-hadoop-cloudera
This repo generates the JupyterHub Parcel and CSD(Custom Service Descriptor) to support 
@jimcrist's jupyter-on-hadoop effort. Ideally, this repo will move under the 
jupyterhub-on-hadoop repo.

Documentation in this repo is strictly restricted to the generation of parcels and CSDs.
For instructions on how to use them in your Cloudera Cluster, please refer to the
[Jupyter-on-Hadoop Docs][1]


## Getting started
  1. Update the git submodules.
     ```bash
     git submodule update --init
     ```
  2. Install and activate the development conda environment 
     ```bash
     conda env create
     conda activate cloudera-dev
     ```
  3. Compile and Install the Cloudera's Extension Tools
     ```bash
     pushd cm_ext 
     
     mvn -DskipTests install 
     mkdir -p $CONDA_PREFIX/lib/cloudera
     cp -f validator/target/validator.jar $CONDA_PREFIX/lib/cloudera/
     
     install ../bin/validator.sh $CONDA_PREFIX/bin
     install make_manifest/make_manifest.py $CONDA_PREFIX/bin
     
     popd
     ```
     
## JupyterHub Parcel

  A Cloudera Parcel is nothing more than a `tar.gz` with a `meta` directory at the root.
  The Cloudera Manager(CM) system uses parcels to guarantee a fast and consistent 
  deployment of software artifacts across the cluster. Although multiple versions of a
  parcel can be distributed in a cluster, only one version can be marked as active.
  Generally, a CM parcel is extracted to the `${PARCEL_ROOT}/<NAME>-<VERSION>` directory, 
  where `${PARCEL_ROOT}` defaults to `/opt/cloudera/parcels`.  The sys-admin has the
  ability to change this directory, but I find it will be unlikely for this happen.
  
  From a `conda`-user perspective, a `.parcel` file can be correctly generated by 
  creating a conda environment, adding the parcel metadata to the `meta` directory and 
  using `conda-pack` to generate a `.tar.gz` file. 
  
  The parcel metadata is a hybrid between a `conda` environment yaml file and a `conda`
  package recipe. It includes metadata items like `name`, `version`, a list
  of `components`. Additionally, it includes a script that is called before the parcel is
  used by any Cloudera Service, and the ability to create users and groups on the cluster
  nodes where the parcel is installed.
  
  From our JupyterHub-on-Hadoop perspective, we generate a minimally viable parcel for 
  standing the JupyterHub on Cloudera and configuring it to store its state on a remote
  database. It is not the goal of this parcel to be *all inclusive* of packages that a
  Data Scientist would need. This is better solved with `conda-pack` or if necessary 
  creating an additional stand-alone parcel customized to that end-user's need. 
  [[my opinion may change..]]
  
  The instructions for building a new parcel follows:
  1. Add/Replace/Update JupyterHub requirements by editing the
     `parcel/environment.yml` conda-environment file.
  3. Update the version string on `parcel/templates/parcel.yaml`.
  2. Run `build.py`
     ```
     cd parcel
     ./build.py
     ```
  
  To install these built parcel on Cloudera Manager please follow directions outlined
  on [Cloudera's documentation][2]. Hint: you can spin up a local HTTP server using 
  Python 3.x by running `python -m http.server --directory parcels --port 14156`
  
  For more details please see the [cm_ext wiki page][3]

## Building the Custom Service Descriptor jar

  1. Run `build.py`
     ```
     cd csd
     ./build.py
     ```

  [1]: https://jcrist.github.io/jupyterhub-on-hadoop/
  [2]: https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_parcels.html
  [3]: https://github.com/cloudera/cm_ext/wiki